import cv2
import numpy as np
from PIL import Image, ImageDraw, ImageFont
import pillow_heif
import os
from rembg import remove

# HEIC対応読み込み
def load_image(path):
    ext = os.path.splitext(path)[-1].lower()
    if ext == ".heic":
        heif_file = pillow_heif.read_heif(path)
        img = Image.frombytes(heif_file.mode, heif_file.size, heif_file.data, "raw")
        return cv2.cvtColor(np.array(img), cv2.COLOR_RGB2BGR)
    else:
        return cv2.imread(path)

# 黒四角マーカー検出
def detect_marker(image, marker_size_cm=5.0):
    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
    _, thresh = cv2.threshold(gray, 50, 255, cv2.THRESH_BINARY_INV)
    contours, _ = cv2.findContours(thresh, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

    cm_per_pixel = None
    best_cnt = None
    max_area = 0

    for cnt in contours:
        area = cv2.contourArea(cnt)
        if area > 500:  # ノイズ除去
            x, y, w, h = cv2.boundingRect(cnt)
            aspect_ratio = w / float(h)
            if 0.9 < aspect_ratio < 1.1 and area > max_area:
                max_area = area
                best_cnt = cnt

    if best_cnt is not None:
        x, y, w, h = cv2.boundingRect(best_cnt)
        cm_per_pixel = marker_size_cm / np.mean([w, h])
        cv2.rectangle(image, (x, y), (x + w, y + h), (0, 0, 255), 2)
        cv2.putText(image, "Marker", (x, y - 10),
                    cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 0, 255), 2)
    return cm_per_pixel

# 背景除去
def remove_background(image):
    result = remove(image)
    return cv2.cvtColor(np.array(result), cv2.COLOR_RGBA2BGR)

# 服計測
def measure_clothes(image, cm_per_pixel):
    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
    _, thresh = cv2.threshold(gray, 10, 255, cv2.THRESH_BINARY)
    # ノイズ除去のためのクロージング処理
    kernel = np.ones((5, 5), np.uint8)
    thresh = cv2.morphologyEx(thresh, cv2.MORPH_CLOSE, kernel)
    contours, _ = cv2.findContours(thresh, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

    if not contours:
        return None, {}

    clothes_contour = max(contours, key=cv2.contourArea)

    # 凸包で輪郭を滑らかにする
    hull = cv2.convexHull(clothes_contour)
    x, y, w, h = cv2.boundingRect(hull)


    # 最上点・最下点を取得
    ys = clothes_contour[:, :, 1]
    xs = clothes_contour[:, :, 0]
    topmost = tuple(clothes_contour[ys.argmin()][0])
    bottommost = tuple(clothes_contour[ys.argmax()][0])

    min_x = int(xs.min())
    max_x = int(xs.max())
    min_y = int(ys.min())
    max_y = int(ys.max())
    w = max_x - min_x + 1
    height = bottommost[1] - topmost[1]

    # 肩幅（上から10%の位置での幅）
    shoulder_y = min_y + int(height * 0.1)
    shoulder_line = gray[shoulder_y:shoulder_y+5, min_x:min_x+w]
    shoulder_points = cv2.findNonZero(shoulder_line)
    if shoulder_points is None:
        raise ValueError("Shoulder line not detected")
    shoulder_xs = shoulder_points[:, 0, 0]
    shoulder_ys = shoulder_points[:, 0, 1]
    left_idx = np.argmin(shoulder_xs)
    right_idx = np.argmax(shoulder_xs)
    left_shoulder = (min_x + shoulder_xs[left_idx], shoulder_y + shoulder_ys[left_idx])
    right_shoulder = (min_x + shoulder_xs[right_idx], shoulder_y + shoulder_ys[right_idx])
    shoulder_width = right_shoulder[0] - left_shoulder[0]


    # 身幅（下から30%）
    chest_y = y + int(h * 0.7)
    chest_line = gray[chest_y:chest_y+5, x:x+w]

    chest_points = cv2.findNonZero(chest_line)
    if chest_points is None:
        raise ValueError("Chest line not detected")
    chest_xs = chest_points[:, 0, 0]
    left_chest = min_x + chest_xs.min()
    right_chest = min_x + chest_xs.max()
    chest_width = right_chest - left_chest

    # 袖端（凸包の左右端）
    left_sleeve_end = tuple(hull[hull[:, :, 0].argmin()][0])
    right_sleeve_end = tuple(hull[hull[:, :, 0].argmax()][0])

    # 肩端から袖端までの距離
    left_sleeve_length = np.linalg.norm(np.array(left_shoulder) - np.array(left_sleeve_end))
    right_sleeve_length = np.linalg.norm(np.array(right_shoulder) - np.array(right_sleeve_end))
    sleeve_length = (left_sleeve_length + right_sleeve_length) / 2


    # 身丈（凸包の上下端）
    top_point = hull[hull[:, :, 1].argmin()][0]
    bottom_point = hull[hull[:, :, 1].argmax()][0]
    body_length = bottom_point[1] - top_point[1]

    # 身丈（最上点と最下点の距離）
    body_length = bottommost[1] - topmost[1]


    measures = {
        "肩幅": shoulder_width * cm_per_pixel,
        "身幅": chest_width * cm_per_pixel,
        "身丈": body_length * cm_per_pixel,
        "袖丈": sleeve_length * cm_per_pixel,
    }
    return hull, measures

# 画像に寸法描画
def draw_measurements_on_image(image, measurements, font_path=None):
    """Draw measurement text on an image using a font that supports Japanese.

    Parameters
    ----------
    image : numpy.ndarray
        BGR image as used by OpenCV.
    measurements : dict
        Dictionary mapping measurement names to values.
    font_path : str, optional
        Path to a TrueType font capable of rendering Japanese. If not
        provided, the path is taken from the ``JP_FONT_PATH`` environment
        variable. When no font can be loaded, Pillow's default font is used,
        though it may not support Japanese characters.
    """

    if font_path is None:
        font_path = os.getenv("JP_FONT_PATH", "/usr/share/fonts/truetype/noto/NotoSansCJK-Regular.ttc")

    try:
        font = ImageFont.truetype(font_path, size=50)
    except OSError:
        font = ImageFont.load_default()

    pil_img = Image.fromarray(cv2.cvtColor(image, cv2.COLOR_BGR2RGB))
    draw = ImageDraw.Draw(pil_img)

    y_offset = 60
    for key, value in measurements.items():
        text = f"{key}: {value:.1f} cm"
        draw.text((30, y_offset), text, font=font, fill=(0, 255, 0))
        y_offset += 60

    return cv2.cvtColor(np.array(pil_img), cv2.COLOR_RGB2BGR)

if __name__ == "__main__":
    # ===== メイン処理 =====
    image_path = "画像.jpg"  # HEICもJPEGもOK
    img = load_image(image_path)

    # マーカー検出（背景除去前）
    cm_per_pixel = detect_marker(img)
    if cm_per_pixel is None:
        print("マーカーが検出できません。終了します。")
        exit()

    # 背景除去
    img_no_bg = remove_background(img)

    # 服計測
    try:
        contour, measurements = measure_clothes(img_no_bg, cm_per_pixel)
    except ValueError as e:
        print(f"計測エラー: {e}")
        exit()
    if contour is None:
        print("服が検出できません。")
        exit()

    # 寸法表示
    for k, v in measurements.items():
        print(f"{k}: {v:.1f} cm")

    font_path = os.getenv("JP_FONT_PATH")
    img_with_text = draw_measurements_on_image(img.copy(), measurements, font_path=font_path)
    cv2.drawContours(img_with_text, [contour], -1, (255, 0, 0), 2)

    # 保存
    cv2.imwrite("clothes_with_measurements.jpg", img_with_text)
    print("寸法入り画像を保存しました → clothes_with_measurements.jpg")

